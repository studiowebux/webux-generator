The middleware functions are here.